-- This document includes the steps taken for the Process Phase and the Analyze Phase.
-- It also contains the SQL script used in almost all of its steps.

-- PROCESS PHASE

-- 1. Data Format Verification:
-- Data was converted to .xlsx format for proper import into SQL.

-- 2. Column and Data Type Verification:
-- Verify column names and data types during the file upload process.
-- We review column names, types, and null allowances across 12 monthly datasets.

-- 3. Data Consolidation:
-- Merge the 12 monthly tables into a single table.

-- SQL Query for data consolidation:
SELECT *
INTO Cyclistic_TripData_2022
FROM divvy_tripdata_202201
UNION ALL
SELECT *
FROM divvy_tripdata_202202
UNION ALL
SELECT *
FROM divvy_tripdata_202203
UNION ALL
SELECT *
FROM divvy_tripdata_202204
UNION ALL
SELECT *
FROM divvy_tripdata_202205
UNION ALL
SELECT *
FROM divvy_tripdata_202206
UNION ALL
SELECT *
FROM divvy_tripdata_202207
UNION ALL
SELECT *
FROM divvy_tripdata_202208
UNION ALL
SELECT *
FROM divvy_tripdata_202209
UNION ALL
SELECT *
FROM divvy_tripdata_202210
UNION ALL
SELECT *
FROM divvy_tripdata_202211
UNION ALL
SELECT *
FROM divvy_tripdata_202212
;

-- Note: This breakdown will be used in the following step.
-- Breakdown of the FROM Clause:
-- cyclistic_bike_share: This is the name of the database that contains your table.
-- dbo: This is the schema within the database.
-- Cyclistic_TripData_2022: This is the specific table created from the consolidated data.

-- 4. Error Detection:
-- Verify categorical values and check for duplicates.

-- SQL Query for Checking categories for rideable_type:
SELECT
	rideable_type
FROM 
	cyclistic_bike_share.dbo.Cyclistic_TripData_2022
GROUP BY
	rideable_type
;

-- SQL Query for checking categories for member_casual column:
SELECT 
	DISTINCT member_casual
FROM 
	cyclistic_bike_share.dbo.Cyclistic_TripData_2022
;

-- SQL Query for checking duplicates in the ride_id column:
SELECT
	ride_id,
	COUNT(*) as duplicate_count
FROM 
	cyclistic_bike_share.dbo.Cyclistic_TripData_2022
GROUP BY
	ride_id
HAVING
	COUNT(*) > 1
;

-- 5. Null Value Management:
-- Analyze and retain records with essential data, despite null values in station columns.

-- SQL Query for checking null values in all columns:
SELECT
   SUM(CASE WHEN ride_id IS NULL THEN 1 ELSE 0 END) AS ride_id_null_count,
   SUM(CASE WHEN rideable_type IS NULL THEN 1 ELSE 0 END) AS rideable_type_null_count,
   SUM(CASE WHEN started_at IS NULL THEN 1 ELSE 0 END) AS started_at_null_count,
   SUM(CASE WHEN ended_at IS NULL THEN 1 ELSE 0 END) AS ended_at_null_count,
   SUM(CASE WHEN start_station_name IS NULL THEN 1 ELSE 0 END) AS start_station_name_null_count,
   SUM(CASE WHEN start_station_id IS NULL THEN 1 ELSE 0 END) AS start_station_id_null_count,
   SUM(CASE WHEN end_station_name IS NULL THEN 1 ELSE 0 END) AS end_station_name_null_count,
   SUM(CASE WHEN end_station_id IS NULL THEN 1 ELSE 0 END) AS end_station_id_null_count,
   SUM(CASE WHEN start_lat IS NULL THEN 1 ELSE 0 END) AS start_lat_null_count,
   SUM(CASE WHEN start_lng IS NULL THEN 1 ELSE 0 END) AS start_lng_null_count,
   SUM(CASE WHEN end_lat IS NULL THEN 1 ELSE 0 END) AS end_lat_null_count,
   SUM(CASE WHEN end_lng IS NULL THEN 1 ELSE 0 END) AS end_lng_null_count,
   SUM(CASE WHEN member_casual IS NULL THEN 1 ELSE 0 END) AS member_casual_null_count
FROM 
   cyclistic_bike_share.dbo.Cyclistic_TripData_2022
;

-- 6. New Column Creation:
-- Create new columns for enhanced analysis and populate them.

-- SQL Query for creating a column for trip duration in seconds:
ALTER TABLE 
	cyclistic_bike_share.dbo.Cyclistic_TripData_2022
ADD 
	ride_length_seconds float
;

-- SQL Query for populating the trip duration column in seconds:
UPDATE 
	cyclistic_bike_share.dbo.Cyclistic_TripData_2022
SET 
	ride_length_seconds = DATEDIFF(SECOND, started_at, ended_at)
;

-- SQL Query for creating a column for the hour of the day:
ALTER TABLE
	cyclistic_bike_share.dbo.Cyclistic_TripData_2022
ADD
	hour_of_day nvarchar(50)
;

-- SQL Query for populating the hour of the day column:
UPDATE 
	cyclistic_bike_share.dbo.Cyclistic_TripData_2022
SET 
	hour_of_day = FORMAt(started_at, 'HH')
;

-- SQL Query for creating a column for the day of the week:
ALTER TABLE 
	cyclistic_bike_share.dbo.Cyclistic_TripData_2022
ADD	
	day_of_week nvarchar(50)
;

-- SQL Query for populating the day of the week column:
UPDATE
	cyclistic_bike_share.dbo.Cyclistic_TripData_2022
SET 
	day_of_week = FORMAt(started_at, 'dddd')
;

-- SQL Query for creating a column for the month:
ALTER TABLE 
	cyclistic_bike_share.dbo.Cyclistic_TripData_2022
ADD 
	month nvarchar(50)
;

-- SQL Query for populating the month column:
UPDATE 
	cyclistic_bike_share.dbo.Cyclistic_TripData_2022
SET 
	month = FORMAt(started_at, 'MMMM')
;

-- 7. Data Validation:
-- Remove invalid entries where ride_length_seconds <= 0 or the ride exceeds 24 hours.

-- SQL Query for checking if there is any ride_length_seconds less than or equal to 0
SELECT
	 COUNT(ride_length_seconds)
FROM
	cyclistic_bike_share.dbo.Cyclistic_TripData_2022
WHERE
	ride_length_seconds <= 0
;

-- SQL Query for checking if any rides lasted longer than a day (24 hours).
SELECT
	 COUNT(ride_length_seconds)
FROM
	cyclistic_bike_share.dbo.Cyclistic_TripData_2022
WHERE
	ride_length_seconds >= 24*60*60
;

-- SQL Query for deleting rows where ride_length_seconds â‰¤ 0 or the ride exceeds 24 hours.
DELETE
FROM
	cyclistic_bike_share.dbo.Cyclistic_TripData_2022
WHERE
	ride_length_seconds <= 0 
	OR ride_length_seconds >= 24*60*60
;

-- ANALYZE PHASE

-- 1. Preferred Types of Bikes for Each Rider Group Over the Year:
SELECT member_casual, rideable_type, COUNT(*) AS bike_count
FROM full_year_data
GROUP BY member_casual, rideable_type;

-- 2. Average Ride Length by Each Rider Group Per Hour:
SELECT member_casual, hour_of_day, AVG(ride_length_seconds) AS avg_ride_length
FROM full_year_data
GROUP BY member_casual, hour_of_day;

-- 3. Average Ride Length by Each Rider Group Per Day:
SELECT member_casual, day_of_week, AVG(ride_length_seconds) AS avg_ride_length
FROM full_year_data
GROUP BY member_casual, day_of_week;

-- 4. Average Ride Length by Each Rider Group Per Month:
SELECT member_casual, month, AVG(ride_length_seconds) AS avg_ride_length
FROM full_year_data
GROUP BY member_casual, month;

-- 5. Annual Average Ride Length by Each Rider Group:
SELECT member_casual, AVG(ride_length_seconds) AS avg_ride_length
FROM full_year_data
GROUP BY member_casual;

-- 6. Total Time Spent by Each Rider Group Per Hour:
SELECT member_casual, hour_of_day, SUM(ride_length_seconds) AS total_time
FROM full_year_data
GROUP BY member_casual, hour_of_day;

-- 7. Total Time Spent by Each Rider Group Per Day:
SELECT member_casual, day_of_week, SUM(ride_length_seconds) AS total_time
FROM full_year_data
GROUP BY member_casual, day_of_week;

-- 8. Total Time Spent by Each Rider Group Per Month:
SELECT member_casual, month, SUM(ride_length_seconds) AS total_time
FROM full_year_data
GROUP BY member_casual, month;

-- 9. Annual Time Spent Percentage by Each Rider Group:
SELECT member_casual, 
       SUM(ride_length_seconds) / (SELECT SUM(ride_length_seconds) FROM full_year_data) * 100 AS percentage_time
FROM full_year_data
GROUP BY member_casual;

-- 10. Total Number of Rides by Each Rider Group Per Hour:
SELECT member_casual, hour_of_day, COUNT(*) AS total_rides
FROM full_year_data
GROUP BY member_casual, hour_of_day;

-- 11. Total Number of Rides by Each Rider Group Per Day:
SELECT member_casual, day_of_week, COUNT(*) AS total_rides
FROM full_year_data
GROUP BY member_casual, day_of_week;

-- 12. Total Number of Rides by Each Rider Group Per Month:
SELECT member_casual, month, COUNT(*) AS total_rides
FROM full_year_data
GROUP BY member_casual, month;

-- 13. Annual Total Rides Percentage by Each Rider Group:
SELECT member_casual, 
       COUNT(*) / (SELECT COUNT(*) FROM full_year_data) * 100 AS percentage_rides
FROM full_year_data
GROUP BY member_casual;

-- 14. Top 5 Routes for Each Group:
-- Top 5 routes for Members:
SELECT start_station_name, end_station_name, COUNT(*) AS route_count
FROM full_year_data
WHERE member_casual = 'member'
GROUP BY start_station_name, end_station_name
ORDER BY route_count DESC
LIMIT 5;

-- Top 5 routes for Casual Riders:
SELECT start_station_name, end_station_name, COUNT(*) AS route_count
FROM full_year_data
WHERE member_casual = 'casual'
GROUP BY start_station_name, end_station_name
ORDER BY route_count DESC
LIMIT 5;
